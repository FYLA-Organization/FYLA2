import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  FlatList,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  Dimensions,
  Alert,
  RefreshControl,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useNavigation, useRoute } from '@react-navigation/native';
import { StackNavigationProp } from '@react-navigation/stack';
import { RouteProp } from '@react-navigation/native';
import { ServiceProvider, RootStackParamList } from '../../types';
import ApiService from '../../services/api';
import SearchBar from '../../components/SearchBar';
import ProfilePicture from '../../components/ProfilePicture';
import FilterModal from '../../components/FilterModal';

type SearchScreenNavigationProp = StackNavigationProp<RootStackParamList>;

const EnhancedSearchScreen: React.FC = () => {
  const [searchQuery, setSearchQuery] = useState('');
  const [providers, setProviders] = useState<ServiceProvider[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [filters, setFilters] = useState<SearchFilters>({});
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
  const [showSearchHistory, setShowSearchHistory] = useState(false);
  const [isSearchFocused, setIsSearchFocused] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);
  
  const navigation = useNavigation<SearchScreenNavigationProp>();

  useEffect(() => {
    loadSearchPreferences();
  }, []);

  useEffect(() => {
    const delayedSearch = setTimeout(() => {
      if (searchQuery.length > 2 || SearchService.hasActiveFilters(filters)) {
        performSearch();
      } else if (searchQuery.length === 0 && !SearchService.hasActiveFilters(filters)) {
        loadFeaturedProviders();
      }
    }, 300); // Debounce search

    return () => clearTimeout(delayedSearch);
  }, [searchQuery, filters]);

  const loadSearchPreferences = async () => {
    try {
      const preferences = await SearchService.getSearchPreferences();
      if (Object.keys(preferences).length > 0) {
        setFilters(preferences);
      }
    } catch (error) {
      console.error('Error loading search preferences:', error);
    }
  };

  const loadFeaturedProviders = async () => {
    setIsLoading(true);
    try {
      const response = await ApiService.getServiceProviders(1, 20, {});
      setProviders(response.data);
    } catch (error) {
      console.error('Error loading providers:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const performSearch = async () => {
    setIsLoading(true);
    setHasSearched(true);
    setShowSearchHistory(false);
    
    try {
      console.log('=== ENHANCED SEARCH DEBUG ===');
      console.log('Search query:', searchQuery);
      console.log('Current filters:', filters);
      
      // Save to recent searches
      if (searchQuery.trim() || SearchService.hasActiveFilters(filters)) {
        await SearchService.addRecentSearch(searchQuery, filters);
      }
      
      // Create search parameters that match backend expectations
      const searchParams: any = {
        page: 1,
        pageSize: 20,
      };
      
      // Add query if present
      if (searchQuery.trim()) {
        searchParams.query = searchQuery.trim();
      }
      
      // Add category filter if present and not "All"
      if (filters.category && filters.category !== 'All') {
        searchParams.category = filters.category;
      }
      
      // Add rating filter if present
      if (filters.rating) {
        searchParams.minRating = filters.rating;
      }
      
      // Add price filters if present
      if (filters.priceMin) {
        searchParams.priceMin = filters.priceMin;
      }
      
      if (filters.priceMax) {
        searchParams.priceMax = filters.priceMax;
      }
      
      // Add location/distance filter if present
      if (filters.distance) {
        // Extract number from distance string (e.g., "5 mi" -> 5)
        const distanceValue = parseFloat(filters.distance.replace(/[^\d.]/g, ''));
        searchParams.distance = distanceValue;
      }
      
      console.log('Final search params:', searchParams);
      
      const response = await ApiService.getServiceProviders(
        searchParams.page, 
        searchParams.pageSize, 
        {
          category: searchParams.category,
          rating: searchParams.minRating,
          priceMin: searchParams.priceMin,
          priceMax: searchParams.priceMax,
          distance: searchParams.distance ? `${searchParams.distance} mi` : undefined,
        },
        searchParams.query
      );
      
      console.log('Search response:', response);
      console.log('Providers found:', response.data.length);
      
      let sortedProviders = response.data;
      
      // Client-side sorting for better UX
      if (filters.sortBy && sortedProviders.length > 0) {
        sortedProviders = [...sortedProviders].sort((a, b) => {
          const order = filters.sortOrder === 'asc' ? 1 : -1;
          
          switch (filters.sortBy) {
            case 'rating':
              return ((b.averageRating || 0) - (a.averageRating || 0)) * order;
            case 'name':
              return a.businessName.localeCompare(b.businessName) * order;
            default:
              return 0;
          }
        });
      }
      
      setProviders(sortedProviders);
    } catch (error) {
      console.error('Error searching:', error);
      Alert.alert('Search Error', 'Failed to search providers. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleSearchSelect = (query: string, selectedFilters: SearchFilters) => {
    setSearchQuery(query);
    setFilters(selectedFilters);
    setShowSearchHistory(false);
    setIsSearchFocused(false);
  };

  const handleApplyFilters = (newFilters: SearchFilters) => {
    setFilters(newFilters);
  };

  const handleSaveFilters = async (filtersToSave: SearchFilters) => {
    try {
      await SearchService.saveSearchPreferences(filtersToSave);
      Alert.alert('Success', 'Filter preferences saved!');
    } catch (error) {
      console.error('Error saving filter preferences:', error);
      Alert.alert('Error', 'Failed to save filter preferences');
    }
  };

  const handleResetFilters = () => {
    setFilters({});
  };

  const handleQuickFilter = (filterKey: keyof SearchFilters, filterValue: any) => {
    setFilters(prev => ({
      ...prev,
      [filterKey]: prev[filterKey] === filterValue ? undefined : filterValue
    }));
  };

  const categories = [
    { name: 'All', icon: 'grid-outline', color: '#666' },
    { name: 'Hair', icon: 'cut-outline', color: '#FF6B6B' },
    { name: 'Nails', icon: 'finger-print-outline', color: '#4ECDC4' },
    { name: 'Makeup', icon: 'color-palette-outline', color: '#FFE66D' },
    { name: 'Massage', icon: 'hand-left-outline', color: '#A8E6CF' },
    { name: 'Skin Care', icon: 'water-outline', color: '#DDA0DD' },
    { name: 'Fitness', icon: 'fitness-outline', color: '#FFA07A' },
  ];

  const renderProviderCard = ({ item }: { item: ServiceProvider }) => (
    <TouchableOpacity
      style={styles.providerCard}
      onPress={() => navigation.navigate('ProviderProfile', { providerId: item.id })}
    >
      <Image
        source={{ uri: item.profilePictureUrl || 'https://via.placeholder.com/80' }}
        style={styles.providerImage}
      />
      <View style={styles.providerInfo}>
        <Text style={styles.providerName}>{item.businessName}</Text>
        <Text style={styles.providerTitle}>{item.businessDescription || 'Professional Services'}</Text>
        
        {/* Specialties */}
        {item.specialties && item.specialties.length > 0 && (
          <View style={styles.specialtiesContainer}>
            {item.specialties.slice(0, 3).map((specialty, index) => (
              <View key={index} style={styles.specialtyTag}>
                <Text style={styles.specialtyText}>{specialty}</Text>
              </View>
            ))}
            {item.specialties.length > 3 && (
              <Text style={styles.moreSpecialties}>+{item.specialties.length - 3} more</Text>
            )}
          </View>
        )}
        
        <View style={styles.rating}>
          <Ionicons name="star" size={16} color="#FFD700" />
          <Text style={styles.ratingText}>
            {item.averageRating?.toFixed(1) || 'New'} ({item.totalReviews || 0})
          </Text>
        </View>
        
        <Text style={styles.price}>{item.priceRange || '$$'}</Text>
      </View>
    </TouchableOpacity>
  );

  return (
    <View style={styles.container}>
      {/* Search Header */}
      <View style={styles.searchHeader}>
        <View style={styles.searchInputContainer}>
          <Ionicons name="search" size={20} color="#666" style={styles.searchIcon} />
          <TextInput
            style={styles.searchInput}
            placeholder="Search providers, services..."
            value={searchQuery}
            onChangeText={setSearchQuery}
            onFocus={() => {
              setIsSearchFocused(true);
              setShowSearchHistory(true);
            }}
            onBlur={() => {
              // Delay hiding search history to allow for selections
              setTimeout(() => setIsSearchFocused(false), 150);
            }}
            onSubmitEditing={performSearch}
            returnKeyType="search"
          />
          {searchQuery.length > 0 && (
            <TouchableOpacity 
              style={styles.clearButton}
              onPress={() => {
                setSearchQuery('');
                setShowSearchHistory(false);
              }}
            >
              <Ionicons name="close-circle" size={20} color="#999" />
            </TouchableOpacity>
          )}
        </View>
        <TouchableOpacity 
          style={[
            styles.filterButton,
            SearchService.hasActiveFilters(filters) && styles.activeFilterButton
          ]} 
          onPress={() => setShowAdvancedFilters(true)}
        >
          <Ionicons name="filter" size={20} color={SearchService.hasActiveFilters(filters) ? "#FF6B6B" : "#666"} />
          {SearchService.hasActiveFilters(filters) && <View style={styles.filterBadge} />}
        </TouchableOpacity>
      </View>

      {/* Active Filters Display */}
      {SearchService.hasActiveFilters(filters) && (
        <View style={styles.activeFiltersContainer}>
          <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.activeFiltersContent}>
            {SearchService.getFilterDisplayText(filters).map((filterText, index) => (
              <View key={index} style={styles.activeFilterChip}>
                <Text style={styles.activeFilterText}>{filterText}</Text>
                <TouchableOpacity 
                  style={styles.removeFilterButton}
                  onPress={() => setFilters({})}
                >
                  <Ionicons name="close" size={14} color="#FF6B6B" />
                </TouchableOpacity>
              </View>
            ))}
            <TouchableOpacity 
              style={styles.clearAllFiltersButton}
              onPress={() => setFilters({})}
            >
              <Text style={styles.clearAllFiltersText}>Clear All</Text>
            </TouchableOpacity>
          </ScrollView>
        </View>
      )}

      {/* Quick Filter Pills */}
      <View style={styles.quickFiltersContainer}>
        <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.quickFiltersContent}>
          {/* Category Quick Filters */}
          {categories.slice(0, 5).map((category, index) => (
            <TouchableOpacity
              key={index}
              style={[
                styles.quickFilterPill,
                filters.category === category.name && styles.activeQuickFilterPill,
              ]}
              onPress={() => handleQuickFilter('category', category.name === 'All' ? undefined : category.name)}
            >
              <Ionicons 
                name={category.icon as any} 
                size={16} 
                color={filters.category === category.name ? 'white' : category.color} 
                style={styles.quickFilterIcon}
              />
              <Text style={[
                styles.quickFilterText,
                filters.category === category.name && styles.activeQuickFilterText,
              ]}>
                {category.name}
              </Text>
            </TouchableOpacity>
          ))}

          {/* Quick Rating Filter */}
          <TouchableOpacity
            style={[
              styles.quickFilterPill,
              filters.rating ? styles.activeQuickFilterPill : null,
            ]}
            onPress={() => handleQuickFilter('rating', filters.rating ? undefined : 4)}
          >
            <Ionicons 
              name="star" 
              size={16} 
              color={filters.rating ? 'white' : '#FFD700'} 
              style={styles.quickFilterIcon}
            />
            <Text style={[
              styles.quickFilterText,
              filters.rating ? styles.activeQuickFilterText : null,
            ]}>
              4+ Stars
            </Text>
          </TouchableOpacity>

          {/* Quick Availability Filter */}
          <TouchableOpacity
            style={[
              styles.quickFilterPill,
              filters.availableToday && styles.activeQuickFilterPill,
            ]}
            onPress={() => handleQuickFilter('availableToday', !filters.availableToday)}
          >
            <Ionicons 
              name="time" 
              size={16} 
              color={filters.availableToday ? 'white' : '#4ECDC4'} 
              style={styles.quickFilterIcon}
            />
            <Text style={[
              styles.quickFilterText,
              filters.availableToday && styles.activeQuickFilterText,
            ]}>
              Today
            </Text>
          </TouchableOpacity>
        </ScrollView>
      </View>

      {/* Search History */}
      {showSearchHistory && isSearchFocused && (
        <SearchHistory
          visible={showSearchHistory}
          onSearchSelect={handleSearchSelect}
        />
      )}

      {/* Results or Loading */}
      {!showSearchHistory && (
        <>
          {/* Results Header */}
          {hasSearched && (
            <View style={styles.resultsHeader}>
              <Text style={styles.resultsCount}>
                {isLoading ? 'Searching...' : `${providers.length} providers found`}
              </Text>
              {providers.length > 0 && (
                <TouchableOpacity 
                  style={styles.sortButton}
                  onPress={() => setShowAdvancedFilters(true)}
                >
                  <Ionicons name="swap-vertical" size={16} color="#666" />
                  <Text style={styles.sortButtonText}>Sort</Text>
                </TouchableOpacity>
              )}
            </View>
          )}

          {/* Provider List */}
          <FlatList
            data={providers}
            renderItem={renderProviderCard}
            keyExtractor={(item) => item.id}
            contentContainerStyle={styles.providerList}
            showsVerticalScrollIndicator={false}
            refreshing={isLoading}
            onRefresh={() => {
              if (searchQuery.length > 2 || SearchService.hasActiveFilters(filters)) {
                performSearch();
              } else {
                loadFeaturedProviders();
              }
            }}
            ListEmptyComponent={() => (
              <View style={styles.emptyState}>
                {isLoading ? (
                  <>
                    <ActivityIndicator size="large" color="#FF6B6B" />
                    <Text style={styles.loadingText}>Finding the best providers for you...</Text>
                  </>
                ) : hasSearched ? (
                  <>
                    <Ionicons name="search-outline" size={64} color="#ccc" />
                    <Text style={styles.emptyTitle}>No providers found</Text>
                    <Text style={styles.emptyText}>
                      Try adjusting your search terms or filters
                    </Text>
                    <TouchableOpacity 
                      style={styles.adjustFiltersButton}
                      onPress={() => setShowAdvancedFilters(true)}
                    >
                      <Text style={styles.adjustFiltersText}>Adjust Filters</Text>
                    </TouchableOpacity>
                  </>
                ) : (
                  <>
                    <Ionicons name="compass-outline" size={64} color="#ccc" />
                    <Text style={styles.emptyTitle}>Discover Amazing Providers</Text>
                    <Text style={styles.emptyText}>
                      Search for services or browse by category
                    </Text>
                  </>
                )}
              </View>
            )}
          />
        </>
      )}

      {/* Advanced Filter Modal */}
      <AdvancedFilterModal
        visible={showAdvancedFilters}
        onClose={() => setShowAdvancedFilters(false)}
        filters={filters}
        onApplyFilters={handleApplyFilters}
        onSaveFilters={handleSaveFilters}
        onResetFilters={handleResetFilters}
      />
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.background.primary,
  },
  searchHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: Spacing.md,
    paddingTop: 50,
    backgroundColor: Colors.background.card,
    ...Shadows.small,
    gap: Spacing.sm,
  },
  searchInputContainer: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: Colors.neutral[100],
    borderRadius: BorderRadius.round,
    paddingHorizontal: Spacing.md,
    height: 48,
    borderWidth: 1,
    borderColor: Colors.border.light,
  },
  searchIcon: {
    marginRight: Spacing.sm,
  },
  searchInput: {
    flex: 1,
    ...Typography.body.medium,
    color: Colors.text.primary,
  },
  clearButton: {
    padding: Spacing.xs,
  },
  filterButton: {
    width: 48,
    height: 48,
    borderRadius: BorderRadius.round,
    backgroundColor: Colors.neutral[100],
    alignItems: 'center',
    justifyContent: 'center',
    position: 'relative',
    borderWidth: 1,
    borderColor: Colors.border.light,
  },
  activeFilterButton: {
    backgroundColor: Colors.primary.light + '20',
    borderColor: Colors.primary.main,
  },
  filterBadge: {
    position: 'absolute',
    top: 8,
    right: 8,
    width: 8,
    height: 8,
    borderRadius: BorderRadius.xs,
    backgroundColor: Colors.accent.main,
  },
  activeFiltersContainer: {
    backgroundColor: Colors.background.card,
    paddingVertical: Spacing.sm,
    borderBottomWidth: 1,
    borderBottomColor: Colors.border.light,
  },
  activeFiltersContent: {
    paddingHorizontal: Spacing.md,
    gap: Spacing.sm,
  },
  activeFilterChip: {
    ...ComponentStyles.chips.selected,
    backgroundColor: Colors.primary.main,
  },
  activeFilterText: {
    ...Typography.label.small,
    color: '#FFFFFF',
    fontWeight: '600',
  },
  removeFilterButton: {
    padding: Spacing.xs,
  },
  clearAllFiltersButton: {
    ...ComponentStyles.chips.secondary,
  },
  clearAllFiltersText: {
    ...Typography.label.small,
    color: Colors.text.secondary,
    fontWeight: '600',
  },
  quickFiltersContainer: {
    backgroundColor: Colors.background.card,
    paddingVertical: Spacing.sm,
    borderBottomWidth: 1,
    borderBottomColor: Colors.border.light,
  },
  quickFiltersContent: {
    paddingHorizontal: Spacing.md,
    gap: Spacing.sm,
  },
  quickFilterPill: {
    ...ComponentStyles.chips.outlined,
    backgroundColor: Colors.background.primary,
  },
  activeQuickFilterPill: {
    ...ComponentStyles.chips.selected,
    backgroundColor: Colors.primary.main,
  },
  quickFilterIcon: {
    // No additional styles needed
  },
  quickFilterText: {
    ...Typography.label.small,
    color: Colors.text.secondary,
    fontWeight: '600',
  },
  activeQuickFilterText: {
    color: '#FFFFFF',
  },
  resultsHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: Spacing.md,
    backgroundColor: Colors.background.card,
  },
  resultsCount: {
    ...Typography.body.large,
    color: Colors.text.primary,
    fontWeight: '600',
  },
  sortButton: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: Spacing.xs,
  },
  sortButtonText: {
    ...Typography.body.medium,
    color: Colors.text.secondary,
  },
  providerList: {
    padding: Spacing.md,
    gap: Spacing.md,
  },
  providerCard: {
    ...ComponentStyles.cards.primary,
    backgroundColor: Colors.background.card,
    flexDirection: 'row',
    ...Shadows.card,
  },
  providerImage: {
    width: 80,
    height: 80,
    borderRadius: BorderRadius.round,
    marginRight: Spacing.md,
  },
  providerInfo: {
    flex: 1,
  },
  providerName: {
    ...Typography.heading.h3,
    color: Colors.text.primary,
    marginBottom: Spacing.xs,
  },
  providerTitle: {
    ...Typography.body.medium,
    color: Colors.text.secondary,
    marginBottom: Spacing.sm,
  },
  specialtiesContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: Spacing.xs,
    marginBottom: Spacing.sm,
  },
  specialtyTag: {
    ...ComponentStyles.chips.secondary,
    backgroundColor: Colors.neutral[100],
  },
  specialtyText: {
    ...Typography.label.small,
    color: Colors.text.secondary,
  },
  moreSpecialties: {
    ...Typography.label.small,
    color: Colors.text.tertiary,
    fontStyle: 'italic',
  },
  rating: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: Spacing.xs,
    marginBottom: Spacing.xs,
  },
  ratingText: {
    ...Typography.body.medium,
    color: Colors.text.secondary,
  },
  price: {
    ...Typography.body.large,
    color: Colors.accent.main,
    fontWeight: 'bold',
  },
  emptyState: {
    alignItems: 'center',
    paddingVertical: 64,
    paddingHorizontal: Spacing.xl,
  },
  loadingText: {
    ...Typography.body.large,
    color: Colors.text.secondary,
    marginTop: Spacing.sm,
  },
  emptyTitle: {
    ...Typography.heading.h1,
    color: Colors.text.primary,
    marginTop: Spacing.md,
    marginBottom: Spacing.sm,
  },
  emptyText: {
    ...Typography.body.large,
    color: Colors.text.secondary,
    textAlign: 'center',
    lineHeight: 24,
    marginBottom: Spacing.lg,
  },
  adjustFiltersButton: {
    ...ComponentStyles.buttons.primary,
    backgroundColor: Colors.primary.main,
  },
  adjustFiltersText: {
    ...Typography.button.large,
    color: '#FFFFFF',
  },
});

export default EnhancedSearchScreen;
